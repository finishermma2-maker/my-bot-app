<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-base: #101010; --bg-surface: #1e1e1e; --bg-surface-light: #2c2c2e; 
            --accent: #b4f04b; --text-main: #ffffff; --text-muted: #8e8e93; --border: #333333;
        }
        
        body {
            background-color: var(--bg-base); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent;
        }

        .page {
            display: none; padding: 16px; padding-bottom: 100px; min-height: 100vh;
            box-sizing: border-box; animation: fadeIn 0.2s ease-out;
        }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { margin: 0; font-weight: 600; }
        .section-title { font-size: 20px; margin: 24px 0 16px 0; }
        
        .btn-primary {
            background-color: var(--accent); color: #000000; border: none; border-radius: 12px;
            padding: 16px; font-size: 16px; font-weight: 600; width: 100%; cursor: pointer; transition: 0.2s;
        }
        .btn-primary:active { opacity: 0.7; }
        .btn-text { color: var(--accent); background: none; border: none; font-size: 14px; padding: 0; cursor: pointer; }

        /* НИЖНЕЕ МЕНЮ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-base);
            border-top: 1px solid var(--border); display: flex; justify-content: space-around; 
            align-items: center; padding: 10px 0 20px 0; z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-muted); font-size: 11px; cursor: pointer; transition: 0.2s;
        }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-item.active { color: var(--accent); }

        /* ГЛАВНАЯ */
        .header-profile { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; margin-top: 10px; }
        .header-profile h1 { font-size: 22px; color: var(--text-muted); font-weight: 500;}
        .header-profile h1 span { color: var(--text-main); font-weight: 600; }
        .avatar { width: 44px; height: 44px; background: var(--bg-surface-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .empty-state { background: var(--bg-surface); border-radius: 16px; padding: 24px 16px; text-align: center; margin-bottom: 24px; border: 1px solid var(--border); }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; font-weight: 500;}

        .time-slot { display: flex; gap: 16px; margin-bottom: 16px; align-items: flex-start; }
        .time-label { min-width: 45px; font-size: 15px; font-weight: 600; color: var(--text-muted); padding-top: 14px; text-align: right; }
        .slot-card { flex-grow: 1; background: var(--bg-surface); border-radius: 16px; padding: 16px; border-left: 4px solid var(--accent); }
        .slot-card .name { font-size: 17px; font-weight: 600; margin-bottom: 4px; color: var(--text-main); }
        .slot-card .service { font-size: 14px; color: var(--text-muted); margin-bottom: 8px; }
        .slot-card .notes { font-size: 13px; background: var(--bg-base); padding: 8px 12px; border-radius: 8px; color: #d1d1d6; margin: 0; }

        /* КАЛЕНДАРЬ */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin: 10px 0 24px 0; }
        .cal-header h2 { font-size: 18px; }
        .cal-nav-btn { background: var(--bg-surface); border: none; color: var(--text-main); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; background: var(--bg-surface); padding: 16px; border-radius: 20px; margin-bottom: 24px; }
        .weekday { text-align: center; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 16px; border-radius: 12px; cursor: pointer; position: relative; color: var(--text-main); }
        .day-cell.empty { background: transparent; cursor: default; }
        .day-cell:not(.empty):active { background: var(--bg-surface-light); }
        .day-cell.today { border: 1px solid var(--border); }
        .day-cell.selected { background: var(--accent); color: #000; font-weight: bold; }
        
        .day-cell.has-records::after { content: ''; width: 5px; height: 5px; background: var(--text-muted); border-radius: 50%; position: absolute; bottom: 4px; }
        .day-cell.selected.has-records::after { background: #000; }

        /* МОДАЛЬНОЕ ОКНО */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-base); z-index: 2000; padding: 16px; overflow-y: auto; }
        .modal.active { display: block; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; margin-top: 10px;}
        .back-btn { background: none; border: none; color: var(--accent); font-size: 24px; padding: 0; cursor: pointer; }
        
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; margin-left: 4px;}
        input, select, textarea { width: 100%; padding: 16px; border: 1px solid var(--border); border-radius: 14px; background: var(--bg-surface); color: var(--text-main); font-size: 16px; box-sizing: border-box; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
        input[type="time"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        textarea { min-height: 100px; resize: none; }
    </style>
</head>
<body>

    <nav class="bottom-nav" id="bottomNav">
        <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            Главная
        </div>
        <div class="nav-item" id="nav-calendar" onclick="switchTab('calendar')">
            <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
            Календарь
        </div>
        <div class="nav-item" id="nav-clients" onclick="alert('Раздел базы клиентов в разработке')">
            <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
            Клиенты
        </div>
        <div class="nav-item" id="nav-profile" onclick="alert('Настройки профиля мастера')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            Профиль
        </div>
    </nav>

    <div id="tab-home" class="page active">
        <div class="header-profile">
            <h1>Добро пожаловать, <br><span id="masterName">Мастер</span>!</h1>
            <div class="avatar">✂️</div>
        </div>

        <div class="section-title">Сегодняшние записи</div>
        <div id="homeScheduleContainer"></div>
    </div>

    <div id="tab-calendar" class="page">
        <div class="cal-header">
            <button class="cal-nav-btn" onclick="changeMonth(-1)">❮</button>
            <h2 id="monthYearDisplay">Февраль 2026</h2>
            <button class="cal-nav-btn" onclick="changeMonth(1)">❯</button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid"></div>

        <button class="btn-primary" style="margin-top: 10px;" onclick="openAddForm()">Добавить запись</button>
        
        <div class="section-title" id="selectedDateTitle" style="margin-top: 32px;">Выбранный день</div>
        <div id="calendarScheduleContainer"></div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-header">
            <button class="back-btn" onclick="closeAddForm()">❮ Назад</button>
            <h2>Новая запись</h2>
        </div>
        
        <div class="input-group">
            <label>Дата визита</label>
            <input type="date" id="appDate">
        </div>
        
        <div class="input-group">
            <label>Время</label>
            <input type="time" id="appTime">
        </div>

        <div class="input-group">
            <label>Имя клиента</label>
            <input type="text" id="clientName" placeholder="Например, Анна">
        </div>

        <div class="input-group">
            <label>Услуга</label>
            <select id="service">
                <option value="Стрижка">Стрижка</option>
                <option value="Окрашивание">Окрашивание</option>
                <option value="Сложное окрашивание">Сложное окрашивание</option>
                <option value="Укладка">Укладка</option>
            </select>
        </div>

        <div class="input-group">
            <label>Особенности (формула, пожелания)</label>
            <textarea id="notes" placeholder="Оксид 3%, косой пробор..."></textarea>
        </div>
        
        <button class="btn-primary" style="margin-top: 24px;" onclick="saveAppointment()">Сохранить запись</button>
    </div>

    <script>
        // ИНИЦИАЛИЗАЦИЯ TELEGRAM (с защитой от обычного браузера)
        let tg;
        try {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.setHeaderColor('#101010');
            tg.setBackgroundColor('#101010');
            if(tg.initDataUnsafe && tg.initDataUnsafe.user) {
                document.getElementById('masterName').innerText = tg.initDataUnsafe.user.first_name;
            }
        } catch (e) {
            console.log("Запущено вне Telegram");
        }

        // БАЗА ДАННЫХ
        let db = JSON.parse(localStorage.getItem('begy_crm')) || {};
        
        let todayDate = new Date();
        let currentMonth = todayDate.getMonth();
        let currentYear = todayDate.getFullYear();
        let selectedDateStr = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;

        // НАВИГАЦИЯ (ИСПРАВЛЕНА!)
        function switchTab(tabId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            if (tabId === 'home') {
                let todayStr = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;
                renderSchedule(todayStr, 'homeScheduleContainer', true);
            }
        }

        const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
        const dayNames = ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"];

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            document.getElementById('monthYearDisplay').innerText = `${monthNames[currentMonth]} ${currentYear}`;

            dayNames.forEach(day => { grid.innerHTML += `<div class="weekday">${day}</div>`; });

            let firstDay = new Date(currentYear, currentMonth, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1; 
            let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="day-cell empty"></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let isToday = (day === todayDate.getDate() && currentMonth === todayDate.getMonth() && currentYear === todayDate.getFullYear());
                let isSelected = (dateStr === selectedDateStr);
                let hasRecords = db[dateStr] && db[dateStr].length > 0;
                
                let classNames = `day-cell ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''} ${hasRecords ? 'has-records' : ''}`;
                
                let cell = document.createElement('div');
                cell.className = classNames;
                cell.innerText = day;
                cell.onclick = () => selectDay(dateStr, day);
                grid.appendChild(cell);
            }
            renderSchedule(selectedDateStr, 'calendarScheduleContainer', false);
        }

        function changeMonth(step) {
            currentMonth += step;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        }

        function selectDay(dateStr, day) {
            selectedDateStr = dateStr;
            document.getElementById('selectedDateTitle').innerText = `${day} ${monthNames[currentMonth]}`;
            renderCalendar(); 
        }

        function renderSchedule(dateStr, containerId, isHome) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            let dayApps = db[dateStr] || [];
            
            if (dayApps.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <h3>Событий не запланировано</h3>
                    <button class="btn-text" onclick="switchTab('calendar'); openAddForm();">Запланировать</button>
                </div>`;
            } else {
                dayApps.sort((a, b) => a.time.localeCompare(b.time));
                dayApps.forEach(app => {
                    let notesHtml = app.notes ? `<p class="notes">${app.notes}</p>` : '';
                    container.innerHTML += `
                    <div class="time-slot">
                        <div class="time-label">${app.time}</div>
                        <div class="slot-card">
                            <div class="name">${app.name}</div>
                            <div class="service">${app.service}</div>
                            ${notesHtml}
                        </div>
                    </div>`;
                });
            }
        }

        function openAddForm() {
            document.getElementById('appDate').value = selectedDateStr;
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddForm() {
            document.getElementById('addModal').classList.remove('active');
        }

        function saveAppointment() {
            let date = document.getElementById('appDate').value;
            let time = document.getElementById('appTime').value;
            let name = document.getElementById('clientName').value;
            let service = document.getElementById('service').value;
            let notes = document.getElementById('notes').value;
            
            if(date && time && name) {
                if (!db[date]) db[date] = [];
                db[date].push({ time, name, service, notes });
                localStorage.setItem('begy_crm', JSON.stringify(db)); 
                
                closeAddForm();
                
                let [y, m, d] = date.split('-');
                currentYear = parseInt(y); currentMonth = parseInt(m) - 1; selectedDateStr = date;
                
                renderCalendar();
                if(document.getElementById('tab-home').classList.contains('active')) switchTab('home'); 
                
                try { tg.HapticFeedback.notificationOccurred('success'); } catch(e){}
            } else {
                alert("Пожалуйста, заполните Дату, Время и Имя клиента!");
            }
        }

        // Запуск
        renderCalendar();
        switchTab('home'); 
    </script>
</body>
</html>