<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa; --card-bg: #ffffff; --text-main: #1d1d1f; --text-muted: #86868b;
            --accent-color: #ff6b4a; --gradient-start: #ff8e53; --gradient-end: #ff512f;
        }
        body {
            background-color: var(--bg-color); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0; padding: 16px; padding-bottom: 90px;
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }
        
        .date-picker-btn {
            background: var(--card-bg); border: 1px solid #ddd; border-radius: 12px;
            padding: 8px 12px; font-size: 14px; display: flex; align-items: center;
            cursor: pointer; position: relative; font-weight: 500;
        }
        .date-picker-btn input[type="date"] {
            position: absolute; opacity: 0; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;
        }

        /* –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ö–ê–õ–ï–ù–î–ê–†–¨: —Ç–µ–ø–µ—Ä—å –æ–Ω —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è –∏ –Ω–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
        .week-calendar {
            display: flex; gap: 12px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 15px;
            scrollbar-width: none; scroll-behavior: smooth;
        }
        .week-calendar::-webkit-scrollbar { display: none; }
        
        .day-card {
            flex: 0 0 64px; /* –ñ–ï–°–¢–ö–ê–Ø –®–ò–†–ò–ù–ê: –∑–∞–ø—Ä–µ—â–∞–µ–º —Å–∂–∏–º–∞—Ç—å—Å—è */
            padding: 14px 0; background: var(--card-bg); border-radius: 18px;
            text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s;
        }
        .day-card.active { 
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); 
            color: white; box-shadow: 0 6px 15px rgba(255, 81, 47, 0.3); border-color: transparent;
        }
        .day-card .weekday { font-size: 13px; margin-bottom: 4px; opacity: 0.8; font-weight: 500;}
        .day-card .day-num { font-size: 22px; font-weight: 700; }

        /* –¢–ê–ô–ú–õ–ê–ô–ù –ó–ê–ü–ò–°–ï–ô */
        .timeline { display: flex; flex-direction: column; gap: 16px; }
        .timeline-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .time-slot { display: flex; gap: 12px; align-items: flex-start; }
        .time-label { min-width: 45px; font-size: 15px; font-weight: 600; color: var(--text-main); padding-top: 10px; text-align: right; }
        .slot-card {
            flex-grow: 1; background: var(--card-bg); border-radius: 18px; padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04); position: relative; overflow: hidden;
        }
        .slot-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--accent-color); }
        .slot-client { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .slot-service { font-size: 14px; color: var(--text-muted); margin-bottom: 8px; }
        .slot-notes { font-size: 13px; background: #f9f9fb; padding: 8px 12px; border-radius: 8px; margin: 0; color: #333;}

        /* –ö–ù–û–ü–ö–ê –ò –§–û–†–ú–ê */
        .fab-button {
            position: fixed; bottom: 24px; left: 16px; right: 16px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white; border: none; padding: 18px; border-radius: 20px;
            font-weight: 600; font-size: 17px; box-shadow: 0 10px 25px rgba(255, 81, 47, 0.35); z-index: 10;
        }
        .add-form {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color); z-index: 100; padding: 20px; overflow-y: auto;
        }
        .add-form.active { display: block; }
        input[type="text"], input[type="time"], textarea, select {
            width: 100%; padding: 16px; margin-bottom: 16px; border: 1px solid #e5e5ea;
            border-radius: 14px; font-size: 16px; box-sizing: border-box; background: #fff;
        }
        textarea { min-height: 120px; resize: none; }
    </style>
</head>
<body>
    
    <div id="dashboard">
        <div class="header">
            <h1 id="monthYearTitle">–ú–µ—Å—è—Ü</h1>
            <div class="date-picker-btn">
                üìÖ –í—ã–±—Ä–∞—Ç—å
                <input type="date" id="nativeDatePicker" onchange="jumpToDate(this.value)">
            </div>
        </div>

        <div class="week-calendar" id="calendarScroll">
            </div>

        <div id="timelineContainer" class="timeline"></div>

        <button class="fab-button" onclick="openForm()">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button>
    </div>

    <div id="addForm" class="add-form">
        <div class="header">
            <h2>–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
            <span style="font-size: 32px; color: var(--text-muted);" onclick="closeForm()">√ó</span>
        </div>
        
        <div id="selectedDateDisplay" style="margin-bottom: 20px; color: var(--accent-color); font-weight: 600; font-size: 16px;"></div>
        
        <input type="time" id="appTime" placeholder="–í—Ä–µ–º—è –∑–∞–ø–∏—Å–∏">
        <input type="text" id="clientName" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
        <select id="service">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É...</option>
            <option value="–°—Ç—Ä–∏–∂–∫–∞">–°—Ç—Ä–∏–∂–∫–∞</option>
            <option value="–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
            <option value="–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
            <option value="–£–∫–ª–∞–¥–∫–∞">–£–∫–ª–∞–¥–∫–∞</option>
        </select>
        <textarea id="notes" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–æ–ª–æ—Å, —Ñ–æ—Ä–º—É–ª–∞..."></textarea>
        
        <button class="fab-button" style="position: static; margin-top: 10px;" onclick="saveAppointment()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#f5f7fa');

        let selectedDateStr = "";
        
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        // –ë–µ—Ä–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞, –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
        let appointmentsDB = JSON.parse(localStorage.getItem('crm_data')) || {};

        function renderCalendar(startDate) {
            const scroll = document.getElementById('calendarScroll');
            scroll.innerHTML = '';
            
            const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
            const dayNames = ["–í—Å", "–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"];
            
            document.getElementById('monthYearTitle').innerText = `${monthNames[startDate.getMonth()]}`;

            for (let i = 0; i < 90; i++) {
                let d = new Date(startDate);
                d.setDate(d.getDate() + i);
                
                let dateString = d.toISOString().split('T')[0];
                let isToday = i === 0;

                let card = document.createElement('div');
                card.className = 'day-card' + (isToday ? ' active' : '');
                card.onclick = () => selectDay(card, dateString, d);
                
                card.innerHTML = `<div class="weekday">${dayNames[d.getDay()]}</div><div class="day-num">${d.getDate()}</div>`;
                scroll.appendChild(card);
                
                if (isToday) selectDay(card, dateString, d);
            }
        }

        function selectDay(element, dateStr, dateObj) {
            document.querySelectorAll('.day-card').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
            
            selectedDateStr = dateStr; 
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('selectedDateDisplay').innerText = `–ó–∞–ø–∏—Å—å –Ω–∞: ${dateObj.toLocaleDateString('ru-RU', options)}`;
            
            // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–ª–∏ –¥–µ–Ω—å - —Ä–∏—Å—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ!
            renderTimeline(dateStr);
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ
            element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        // 2. –§–£–ù–ö–¶–ò–Ø –û–¢–†–ò–°–û–í–ö–ò –†–ê–°–ü–ò–°–ê–ù–ò–Ø
        function renderTimeline(dateStr) {
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            let dayAppointments = appointmentsDB[dateStr] || [];
            
            if (dayAppointments.length === 0) {
                container.innerHTML = `
                <div class="timeline-empty">
                    <h3 style="margin-bottom: 5px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
                    <p style="margin-top: 0; font-size: 14px;">–ù–∞–∂–º–∏—Ç–µ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å.</p>
                </div>`;
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–æ—Ç —Ä–∞–Ω–Ω–µ–≥–æ –∫ –ø–æ–∑–¥–Ω–µ–º—É)
            dayAppointments.sort((a, b) => a.time.localeCompare(b.time));

            dayAppointments.forEach(app => {
                let notesHtml = app.notes ? `<p class="slot-notes">${app.notes}</p>` : '';
                container.innerHTML += `
                <div class="time-slot">
                    <div class="time-label">${app.time}</div>
                    <div class="slot-card">
                        <div class="slot-client">${app.name}</div>
                        <div class="slot-service">${app.service}</div>
                        ${notesHtml}
                    </div>
                </div>`;
            });
        }

        function jumpToDate(dateValue) {
            if(!dateValue) return;
            renderCalendar(new Date(dateValue)); 
        }

        function openForm() {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('addForm').classList.add('active');
        }

        function closeForm() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('addForm').classList.remove('active');
        }

        // 3. –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –û–¢–ü–†–ê–í–ö–ê
        function saveAppointment() {
            let time = document.getElementById('appTime').value;
            let name = document.getElementById('clientName').value;
            let service = document.getElementById('service').value;
            let notes = document.getElementById('notes').value;
            
            if(name && service && time) {
                // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (!appointmentsDB[selectedDateStr]) {
                    appointmentsDB[selectedDateStr] = [];
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                appointmentsDB[selectedDateStr].push({
                    time: time, name: name, service: service, notes: notes
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω–∞/–±—Ä–∞—É–∑–µ—Ä–∞
                localStorage.setItem('crm_data', JSON.stringify(appointmentsDB));
                
                let data = {
                    action: 'new_client', date: selectedDateStr, time: time, name: name, service: service, notes: notes
                };
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç—É (Telegram –∑–∞–∫—Ä–æ–µ—Ç –æ–∫–Ω–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ)
                tg.sendData(JSON.stringify(data));
                tg.close();
            } else {
                tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –í—Ä–µ–º—è, –ò–º—è –∏ –£—Å–ª—É–≥—É!");
            }
        }

        renderCalendar(new Date());
    </script>
</body>
</html>