<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa; --card-bg: #ffffff; --text-main: #1d1d1f; --text-muted: #86868b;
            --accent-color: #ff6b4a; --gradient-start: #ff8e53; --gradient-end: #ff512f;
        }
        body {
            background-color: var(--bg-color); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            margin: 0; padding: 0; box-sizing: border-box;
        }
        
        /* –°–ò–°–¢–ï–ú–ê –≠–ö–†–ê–ù–û–í (–í–∏–¥–æ–≤) */
        .view { display: none; padding: 16px; padding-bottom: 90px; min-height: 100vh; box-sizing: border-box; }
        .view.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –®–ê–ü–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø */
        .calendar-header {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); padding: 16px 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; margin-top: 10px;
        }
        .calendar-header button {
            background: none; border: none; font-size: 20px; color: var(--accent-color);
            font-weight: bold; cursor: pointer; padding: 5px 15px;
        }
        .calendar-header h2 { margin: 0; font-size: 18px; text-transform: capitalize; }

        /* –°–ï–¢–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            background: var(--card-bg); padding: 20px; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .weekday { text-align: center; font-size: 13px; color: var(--text-muted); font-weight: 600; margin-bottom: 10px; }
        .day-cell {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 500; border-radius: 12px; cursor: pointer; position: relative;
        }
        .day-cell.empty { background: transparent; cursor: default; }
        .day-cell:not(.empty) { background: #f9f9fb; }
        .day-cell:not(.empty):active { background: #eee; }
        .day-cell.today { border: 2px solid var(--accent-color); color: var(--accent-color); font-weight: bold; background: #fff;}
        .day-cell.has-records::after {
            content: ''; width: 6px; height: 6px; background: var(--accent-color);
            border-radius: 50%; position: absolute; bottom: 5px;
        }

        /* –≠–ö–†–ê–ù –î–ù–Ø: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ */
        .day-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; margin-top: 10px; }
        .timeline-empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .time-slot { display: flex; gap: 12px; margin-bottom: 16px; align-items: flex-start; }
        .time-label { min-width: 45px; font-size: 15px; font-weight: 600; padding-top: 12px; text-align: right; }
        .slot-card {
            flex-grow: 1; background: var(--card-bg); border-radius: 18px; padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04); border-left: 4px solid var(--accent-color);
        }
        .slot-client { font-size: 17px; font-weight: 700; margin-bottom: 4px; }
        .slot-service { font-size: 14px; color: var(--text-muted); margin-bottom: 8px; }
        .slot-notes { font-size: 13px; background: #f9f9fb; padding: 8px; border-radius: 8px; margin: 0; color: #333;}

        /* –ö–ù–û–ü–ö–ê –ò –§–û–†–ú–´ */
        .fab-button {
            position: fixed; bottom: 24px; left: 16px; right: 16px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white; border: none; padding: 18px; border-radius: 20px;
            font-weight: 600; font-size: 17px; box-shadow: 0 10px 25px rgba(255, 81, 47, 0.35); z-index: 10;
        }
        input[type="text"], input[type="time"], textarea, select {
            width: 100%; padding: 16px; margin-bottom: 16px; border: 1px solid #e5e5ea;
            border-radius: 14px; font-size: 16px; box-sizing: border-box; background: #fff;
        }
        textarea { min-height: 120px; resize: none; }
    </style>
</head>
<body>

    <div id="view-calendar" class="view active">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">‚ùÆ</button>
            <h2 id="monthYearDisplay">–ú–∞–π 2026</h2>
            <button onclick="changeMonth(1)">‚ùØ</button>
        </div>
        
        <div class="calendar-grid" id="calendarGrid">
            </div>
    </div>

    <div id="view-day" class="view">
        <div class="day-header" id="dayTitle">15 –ú–∞—è</div>
        
        <div id="timelineContainer"></div>
        
        <button class="fab-button" onclick="openForm()">+ –ó–∞–ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
    </div>

    <div id="view-form" class="view">
        <div class="day-header">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div>
        <div id="formDateLabel" style="margin-bottom: 20px; color: var(--accent-color); font-weight: 600;"></div>
        
        <input type="time" id="appTime" placeholder="–í—Ä–µ–º—è">
        <input type="text" id="clientName" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä. –ê–Ω–Ω–∞)">
        <select id="service">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É...</option>
            <option value="–°—Ç—Ä–∏–∂–∫–∞">–°—Ç—Ä–∏–∂–∫–∞</option>
            <option value="–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
            <option value="–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
            <option value="–£–∫–ª–∞–¥–∫–∞">–£–∫–ª–∞–¥–∫–∞</option>
        </select>
        <textarea id="notes" placeholder="–§–æ—Ä–º—É–ª–∞, –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
        
        <button class="fab-button" style="position: static; margin-top: 10px;" onclick="saveAppointment()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#f5f7fa');

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –æ—Ç –¢–µ–ª–µ–≥—Ä–∞–º–∞
        tg.BackButton.onClick(() => {
            if (currentView === 'form') {
                showView('day');
            } else if (currentView === 'day') {
                showView('calendar');
                renderCalendar(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
            }
        });

        // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        let appointmentsDB = JSON.parse(localStorage.getItem('crm_data')) || {};
        
        // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedDateStr = "";
        let currentView = 'calendar';

        // –ù–ê–í–ò–ì–ê–¶–ò–Ø –ú–ï–ñ–î–£ –≠–ö–†–ê–ù–ê–ú–ò
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            currentView = viewName;
            
            // –£–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥"
            if (viewName === 'calendar') {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
            }
        }

        // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ö–ê–õ–ï–ù–î–ê–†–Ø
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        const dayNames = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            document.getElementById('monthYearDisplay').innerText = `${monthNames[currentMonth]} ${currentYear}`;

            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –≤ —à–∞–ø–∫—É —Å–µ—Ç–∫–∏
            dayNames.forEach(day => {
                grid.innerHTML += `<div class="weekday">${day}</div>`;
            });

            // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ (—Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –Ω–∞ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
            let firstDay = new Date(currentYear, currentMonth, 1).getDay();
            firstDay = firstDay === 0 ? 6 : firstDay - 1; 
            
            let daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let today = new Date();

            // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="day-cell empty"></div>`;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–Ω–∏
            for (let day = 1; day <= daysInMonth; day++) {
                let dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                let isToday = (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear());
                let hasRecords = appointmentsDB[dateStr] && appointmentsDB[dateStr].length > 0;
                
                let classNames = `day-cell ${isToday ? 'today' : ''} ${hasRecords ? 'has-records' : ''}`;
                
                let cell = document.createElement('div');
                cell.className = classNames;
                cell.innerText = day;
                cell.onclick = () => openDaySchedule(dateStr, day);
                grid.appendChild(cell);
            }
        }

        function changeMonth(step) {
            currentMonth += step;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        }

        // –û–¢–ö–†–´–¢–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–Ø –î–ù–Ø
        function openDaySchedule(dateStr, day) {
            selectedDateStr = dateStr;
            document.getElementById('dayTitle').innerText = `${day} ${monthNames[currentMonth]}`;
            
            const container = document.getElementById('timelineContainer');
            container.innerHTML = '';
            
            let dayApps = appointmentsDB[dateStr] || [];
            
            if (dayApps.length === 0) {
                container.innerHTML = `<div class="timeline-empty"><h2>–°–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω—å</h2><p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å.</p></div>`;
            } else {
                dayApps.sort((a, b) => a.time.localeCompare(b.time));
                dayApps.forEach(app => {
                    let notesHtml = app.notes ? `<p class="slot-notes">${app.notes}</p>` : '';
                    container.innerHTML += `
                    <div class="time-slot">
                        <div class="time-label">${app.time}</div>
                        <div class="slot-card">
                            <div class="slot-client">${app.name}</div>
                            <div class="slot-service">${app.service}</div>
                            ${notesHtml}
                        </div>
                    </div>`;
                });
            }
            showView('day');
        }

        // –û–¢–ö–†–´–¢–ò–ï –§–û–†–ú–´
        function openForm() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è
            document.getElementById('appTime').value = '';
            document.getElementById('clientName').value = '';
            document.getElementById('service').value = '';
            document.getElementById('notes').value = '';
            
            let [y, m, d] = selectedDateStr.split('-');
            document.getElementById('formDateLabel').innerText = `–ó–∞–ø–∏—Å—å –Ω–∞: ${d} ${monthNames[parseInt(m)-1]} ${y}`;
            showView('form');
        }

        // –°–û–•–†–ê–ù–ï–ù–ò–ï
        function saveAppointment() {
            let time = document.getElementById('appTime').value;
            let name = document.getElementById('clientName').value;
            let service = document.getElementById('service').value;
            let notes = document.getElementById('notes').value;
            
            if(name && service && time) {
                if (!appointmentsDB[selectedDateStr]) appointmentsDB[selectedDateStr] = [];
                
                appointmentsDB[selectedDateStr].push({ time, name, service, notes });
                localStorage.setItem('crm_data', JSON.stringify(appointmentsDB));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Python (—ç—Ç–æ –∑–∞–∫—Ä–æ–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
                let data = { action: 'new_client', date: selectedDateStr, time, name, service, notes };
                tg.sendData(JSON.stringify(data));
                tg.close();
            } else {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –í—Ä–µ–º—è, –ò–º—è –∏ –£—Å–ª—É–≥—É!");
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        renderCalendar();
    </script>
</body>
</html>