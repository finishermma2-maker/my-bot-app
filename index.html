<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –û—Å–Ω–æ–≤–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
        :root {
            --bg-top: #1DA1F2; 
            --bg-main: #FFFFFF;
            --purple-card: #4a00e0; 
            --purple-light: #8e2de2;
            --text-dark: #1d1d1f;
            --text-muted: #86868b;
            --bg-gray: #f2f2f7;
            --danger-bg: #ffebee;
            --danger-text: #d32f2f;
            --success: #34c759;
            --warning: #ffcc00;
        }

        body {
            background-color: var(--bg-top);
            color: var(--text-dark);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª–∞–¥–æ–∫ (SPA) */
        .page {
            display: none;
            min-height: 100vh;
            box-sizing: border-box;
            animation: fadeIn 0.3s ease;
        }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù (–î–ê–®–ë–û–†–î) --- */
        .top-header { padding: 16px 20px; color: white; display: flex; justify-content: space-between; align-items: center;}
        .top-header-text h1 { margin: 0; font-size: 20px; font-weight: 700; }
        .top-header-text p { margin: 2px 0 0 0; font-size: 12px; opacity: 0.9; }
        .avatar { width: 38px; height: 38px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 1px solid rgba(255,255,255,0.4); }

        .main-container {
            background-color: var(--bg-main); border-radius: 24px 24px 0 0;
            min-height: calc(100vh - 80px); padding: 16px;
            box-sizing: border-box; box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        /* –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .top-stats { display: flex; justify-content: space-between; margin-bottom: 16px; padding: 0 10px; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-label { font-size: 12px; color: var(--text-muted); margin-bottom: 2px; font-weight: 500;}
        .stat-value { font-size: 20px; font-weight: 700; color: var(--text-dark); }
        .stat-right { text-align: right; }

        /* –ë–ª–æ–∫ —Ç–∞–π–º–µ—Ä–æ–≤ (–¥–æ 3 —à—Ç—É–∫) */
        .next-apps-wrapper { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .next-app-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; border-radius: 16px; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: background 0.5s ease;
        }
        .timer-green { background: linear-gradient(135deg, #34c759, #28a745); }
        .timer-yellow { background: linear-gradient(135deg, #ffcc00, #e0a800); color: #000; }
        .timer-red { background: linear-gradient(135deg, #ff3b30, #c82333); }
        .next-app-timer { font-size: 18px; font-weight: 800; font-variant-numeric: tabular-nums; text-align: right; min-width: 85px;}

        /* –°–µ—Ç–∫–∞ –º–µ–Ω—é 2x2 */
        .grid-2x2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .square-btn {
            background: white; border-radius: 16px; padding: 16px 10px; text-align: center; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.1s;
        }
        .square-btn:active { transform: scale(0.96); }
        .icon-circle {
            background-color: var(--purple-card); color: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 8px;
        }
        .icon-circle svg { width: 20px; height: 20px; fill: currentColor; }
        .btn-title { font-size: 14px; font-weight: 700; }

        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ */
        .white-inner-card { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);}
        .toggle-switch { background: var(--bg-gray); border-radius: 16px; display: flex; padding: 4px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; text-align: center; padding: 8px 0; border-radius: 12px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; }
        .toggle-btn.active { background: var(--purple-card); color: white; }

        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .list-item:last-child { border-bottom: none; }
        .time-badge { background: var(--bg-gray); color: var(--purple-card); padding: 5px 10px; border-radius: 8px; font-weight: 700; font-size: 13px;}
        .price-text { font-weight: 700; color: var(--success); font-size: 13px; }

        /* --- –≠–ö–†–ê–ù–´: –ö–õ–ò–ï–ù–¢–´ –ò –§–ò–ù–ê–ù–°–´ --- */
        .sub-page { background: var(--bg-gray); min-height: 100vh; padding: 20px; }
        .header-row { display: flex; align-items: center; margin-bottom: 20px; gap: 12px;}
        .back-btn { background: white; border: none; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .search-box { width: 100%; padding: 12px 16px; border-radius: 14px; border: 1px solid #ddd; margin-bottom: 16px; box-sizing: border-box; font-size: 15px; }
        .client-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .client-formula { font-size: 12px; background: #fffde7; border: 1px solid #fff9c4; padding: 8px; border-radius: 8px; margin-top: 8px; color: #5d4037;}

        .finance-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px; }
        .finance-card { background: white; border-radius: 18px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .fin-val { font-size: 24px; font-weight: 800; color: var(--success); margin: 6px 0;}
        .fin-label { font-size: 13px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;}

        /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 4px; padding-left: 4px; font-weight: 600;}
        input, select, textarea {
            width: 100%; padding: 14px; border: 1px solid #e5e5ea; border-radius: 14px;
            background: white; color: var(--text-dark); font-size: 15px; box-sizing: border-box; font-family: inherit;
        }
        .action-btn {
            background: var(--purple-card); color: white; border: none; border-radius: 14px;
            padding: 16px; font-size: 16px; font-weight: 700; width: 100%; margin-top: 8px; transition: 0.2s;
        }

        .toast-notification {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--text-dark); color: white; padding: 14px 24px;
            border-radius: 30px; font-size: 14px; font-weight: 600; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            transition: 0.4s; z-index: 9999; opacity: 0;
        }
        .toast-notification.show { bottom: 40px; opacity: 1; }

        /* –°—Ç–∏–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .month-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .month-btn { background: white; border: none; border-radius: 10px; width: 36px; height: 36px; color: var(--purple-card); font-weight: bold; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; background: white; padding: 14px; border-radius: 18px; }
        .day-cell { aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 14px; border-radius: 50%; cursor: pointer; position: relative; }
        .day-cell.today { border: 2px solid var(--purple-card); color: var(--purple-card); font-weight: 700; }
        .day-cell.selected { background: var(--purple-card); color: white; }
        .day-cell.has-apps::after { content: ''; width: 4px; height: 4px; background: var(--purple-light); border-radius: 50%; position: absolute; bottom: 4px; }
        .day-cell.is-off { background: var(--danger-bg); color: var(--danger-text); }
        
        .day-off-card { background: var(--danger-bg); border-radius: 16px; padding: 16px; border: 1px solid #ffcdd2; text-align: center; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù 1: –ì–õ–ê–í–ù–ê–Ø -->
    <div id="view-home" class="page active">
        <div class="top-header">
            <div class="top-header-text">
                <h1 id="greetingName">–ì–ª–∞–≤–Ω–∞—è</h1>
                <p id="currentDateDisplay"></p>
            </div>
            <div class="avatar">‚úÇÔ∏è</div>
        </div>
        
        <div class="main-container">
            <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div class="top-stats">
                <div class="stat-item">
                    <span class="stat-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</span>
                    <span class="stat-value" id="totalClientsCounter">0</span>
                </div>
                <div class="stat-item stat-right">
                    <span class="stat-label">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</span>
                    <span class="stat-value" id="totalAppsCounter">0</span>
                </div>
            </div>

            <!-- –ë–õ–û–ö –¢–ê–ô–ú–ï–†–û–í (3 –®–¢) -->
            <div id="nextAppointmentsWrapper" class="next-apps-wrapper"></div>

            <div class="grid-2x2">
                <div class="square-btn" onclick="openView('add')">
                    <div class="icon-circle"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></div>
                    <div class="btn-title">–ó–∞–ø–∏—Å—å</div>
                </div>
                <div class="square-btn" onclick="openView('calendar')">
                    <div class="icon-circle"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg></div>
                    <div class="btn-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div>
                </div>
                <div class="square-btn" onclick="openView('clients')">
                    <div class="icon-circle"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div>
                    <div class="btn-title">–ö–ª–∏–µ–Ω—Ç—ã</div>
                </div>
                <div class="square-btn" onclick="openView('finance')">
                    <div class="icon-circle"><svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg></div>
                    <div class="btn-title">–§–∏–Ω–∞–Ω—Å—ã</div>
                </div>
            </div>

            <div class="white-inner-card">
                <div class="toggle-switch">
                    <div class="toggle-btn active" id="tabToday" onclick="switchScheduleTab('today')">–°–µ–≥–æ–¥–Ω—è</div>
                    <div class="toggle-btn" id="tabTomorrow" onclick="switchScheduleTab('tomorrow')">–ó–∞–≤—Ç—Ä–∞</div>
                </div>
                <div id="dashboardList"></div>
            </div>
        </div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨ -->
    <div id="view-add" class="page sub-page">
        <div class="header-row"><button class="back-btn" onclick="openView('home')">‚ùÆ</button><h2 class="sub-title">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2></div>
        <div class="input-group" style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 14px; border-radius: 14px;">
            <label style="margin: 0; font-size: 15px; color: var(--text-dark); font-weight: 700;">üèñ –í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å</label>
            <input type="checkbox" id="isDayOff" onchange="toggleDayOffUI()" style="width: 20px; height: 20px;">
        </div>
        <div class="input-group"><label>–î–∞—Ç–∞</label><input type="date" id="appDate" onchange="generateTimeSlots()"></div>
        <div id="regularFields">
            <div class="input-group"><label>–í—Ä–µ–º—è</label><select id="appTime"></select></div>
            <div class="input-group"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" id="clientName" placeholder="–ù–∞–ø—Ä. –ú–∞—Ä–∏–Ω–∞"></div>
            <div class="input-group">
                <label>–£—Å–ª—É–≥–∞</label>
                <select id="service">
                    <option value="–°—Ç—Ä–∏–∂–∫–∞">–°—Ç—Ä–∏–∂–∫–∞</option>
                    <option value="–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–û–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
                    <option value="–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ">–°–ª–æ–∂–Ω–æ–µ –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ</option>
                    <option value="–£–∫–ª–∞–¥–∫–∞">–£–∫–ª–∞–¥–∫–∞</option>
                </select>
            </div>
            <div class="input-group"><label>–°—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥–∏ (‚ÇΩ)</label><input type="number" id="appPrice" placeholder="0"></div>
        </div>
        <div class="input-group"><label id="notesLabel">–ó–∞–º–µ—Ç–∫–∏ / –§–æ—Ä–º—É–ª–∞ —Ü–≤–µ—Ç–∞</label><textarea id="notes" placeholder="–§–æ—Ä–º—É–ª–∞: 9.21 + 3%..."></textarea></div>
        <button class="action-btn" id="saveBtn" onclick="saveAppointment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –≠–ö–†–ê–ù: –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <div id="view-calendar" class="page sub-page">
        <div class="header-row"><button class="back-btn" onclick="openView('home')">‚ùÆ</button><h2 class="sub-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h2></div>
        <div class="month-header">
            <button class="month-btn" onclick="changeCalMonth(-1)">‚ùÆ</button>
            <div id="calMonthYear" style="font-weight: 700;"></div>
            <button class="month-btn" onclick="changeCalMonth(1)">‚ùØ</button>
        </div>
        <div class="days-grid" id="calDaysGrid"></div>
        <div id="selectedDayLabel" style="font-weight: 700; margin: 15px 0 10px;"></div>
        <div id="selectedDayAppsContainer"></div>
    </div>

    <!-- –≠–ö–†–ê–ù: –ö–õ–ò–ï–ù–¢–´ -->
    <div id="view-clients" class="page sub-page">
        <div class="header-row"><button class="back-btn" onclick="openView('home')">‚ùÆ</button><h2 class="sub-title">–ë–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2></div>
        <input type="text" class="search-box" id="clientSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏..." oninput="renderClientsList()">
        <div id="clientsListContainer"></div>
    </div>

    <!-- –≠–ö–†–ê–ù: –§–ò–ù–ê–ù–°–´ -->
    <div id="view-finance" class="page sub-page">
        <div class="header-row"><button class="back-btn" onclick="openView('home')">‚ùÆ</button><h2 class="sub-title">–§–∏–Ω–∞–Ω—Å—ã</h2></div>
        <div class="finance-grid">
            <div class="finance-card"><div class="fin-label">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</div><div class="fin-val" id="finToday">0 ‚ÇΩ</div></div>
            <div class="finance-card"><div class="fin-label">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div><div class="fin-val" id="finMonth">0 ‚ÇΩ</div></div>
            <div class="finance-card"><div class="fin-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div><div class="fin-val" id="finAvg">0 ‚ÇΩ</div></div>
        </div>
        <p style="text-align: center; color: var(--text-muted); font-size: 11px;">–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
    </div>

    <div id="toastMessage" class="toast-notification">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <script>
        const API_URL = "https://rich-clocks-fold.loca.lt";

        let tg = window.Telegram.WebApp;
        let masterTgId = "unknown";
        
        try {
            tg.ready(); tg.expand(); tg.setHeaderColor('#1DA1F2');
            if(tg.initDataUnsafe?.user) {
                document.getElementById('greetingName').innerText = "–ü—Ä–∏–≤–µ—Ç, " + tg.initDataUnsafe.user.first_name + "!";
                masterTgId = tg.initDataUnsafe.user.id.toString();
            }
        } catch (e) { console.log("Web mode"); }

        let db = JSON.parse(localStorage.getItem('begy_crm')) || {};
        let todayDate = new Date();
        const monthNamesRel = ["–Ø–Ω–≤–∞—Ä—è", "–§–µ–≤—Ä–∞–ª—è", "–ú–∞—Ä—Ç–∞", "–ê–ø—Ä–µ–ª—è", "–ú–∞—è", "–ò—é–Ω—è", "–ò—é–ª—è", "–ê–≤–≥—É—Å—Ç–∞", "–°–µ–Ω—Ç—è–±—Ä—è", "–û–∫—Ç—è–±—Ä—è", "–ù–æ—è–±—Ä—è", "–î–µ–∫–∞–±—Ä—è"];
        const monthNamesNom = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—è", "–î–µ–∫–∞–±—Ä—å"];
        
        function formatDate(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        let todayStr = formatDate(todayDate);
        if (document.getElementById('currentDateDisplay')) {
            document.getElementById('currentDateDisplay').innerText = `–°–µ–≥–æ–¥–Ω—è ${todayDate.getDate()} ${monthNamesRel[todayDate.getMonth()]}`;
        }

        function openView(v) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            if(tg.setHeaderColor) tg.setHeaderColor(v === 'home' ? '#1DA1F2' : '#f2f2f7');
            
            if(v === 'home') updateDashboard();
            if(v === 'clients') renderClientsList();
            if(v === 'finance') renderFinanceStats();
            if(v === 'calendar') { calSelected = todayStr; calM = todayDate.getMonth(); calY = todayDate.getFullYear(); renderMonthCalendar(); }
            if(v === 'add') { resetAddForm(); document.getElementById('appDate').value = todayStr; generateTimeSlots(); }
        }

        let alarmPlayedFor = null;
        function playBeep() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination); o.type = 'sine'; o.frequency.setValueAtTime(880, ctx.currentTime);
                g.gain.setValueAtTime(0.1, ctx.currentTime); o.start(); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.5); o.stop(ctx.currentTime+0.5);
            } catch(e){}
        }

        function formatTimeLeft(totalM, totalS) {
            if(totalM >= 60) return `${Math.floor(totalM/60)}—á ${totalM%60}–º–∏–Ω`;
            return `${String(totalM).padStart(2,'0')}:${String(totalS).padStart(2,'0')}`;
        }

        function startTimer() {
            const wrapper = document.getElementById('nextAppointmentsWrapper');
            if (!wrapper) return;
            const now = new Date();
            const nowM = now.getHours() * 60 + now.getMinutes();
            
            let future = (db[todayStr] || [])
                .filter(a => !a.isDayOff && timeToMins(a.time) >= nowM)
                .sort((a,b) => timeToMins(a.time) - timeToMins(b.time))
                .slice(0, 3);

            if(future.length === 0) { wrapper.innerHTML = ''; return; }

            wrapper.innerHTML = future.map((app, i) => {
                let [h, m] = app.time.split(':');
                let target = new Date(); target.setHours(parseInt(h), parseInt(m), 0, 0);
                let diff = target - now; if(diff < 0) diff = 0;
                let dm = Math.floor(diff/60000), ds = Math.floor((diff%60000)/1000);
                
                if(i === 0 && dm === 30 && ds === 0 && alarmPlayedFor !== app.time) {
                    playBeep(); showToast("‚è∞ –ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ 30 –º–∏–Ω: " + app.name); alarmPlayedFor = app.time;
                }

                let cl = dm > 60 ? 'timer-green' : (dm > 15 ? 'timer-yellow' : 'timer-red');
                return `<div class="next-app-card ${cl}"><div><b>${app.name}</b><br><small>${app.service}</small></div><div class="next-app-timer">${formatTimeLeft(dm, ds)}</div></div>`;
            }).join('');
        }
        setInterval(() => { if(document.getElementById('view-home').classList.contains('active')) startTimer(); }, 1000);

        function renderClientsList() {
            const cont = document.getElementById('clientsListContainer');
            if (!cont) return;
            const q = document.getElementById('clientSearch').value.toLowerCase();
            let clients = {};
            Object.values(db).flat().forEach(a => {
                if(a.isDayOff) return;
                let n = a.name.trim();
                if(!clients[n]) clients[n] = { count: 0, last: '', formula: '' };
                clients[n].count++;
                if(!clients[n].last || a.date > clients[n].last) clients[n].last = a.date;
                if(a.notes) clients[n].formula = a.notes;
            });
            cont.innerHTML = Object.keys(clients).sort().filter(n => n.toLowerCase().includes(q)).map(n => `
                <div class="client-card">
                    <div style="display:flex; justify-content:space-between"><b>${n}</b><small style="color:var(--purple-card)">–≤–∏–∑–∏—Ç–æ–≤: ${clients[n].count}</small></div>
                    <div style="font-size:11px; color:gray; margin-top:4px">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑: ${clients[n].last}</div>
                    ${clients[n].formula ? `<div class="client-formula">üìù –§–æ—Ä–º—É–ª–∞: ${clients[n].formula}</div>` : ''}
                </div>
            `).join('') || '<p style="text-align:center; color:gray">–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
        }

        function renderFinanceStats() {
            let t=0, m=0, all=0, rev=0;
            let cm = todayDate.getMonth(), cy = todayDate.getFullYear();
            Object.values(db).flat().forEach(a => {
                if(a.isDayOff || !a.price) return;
                let p = parseFloat(a.price), ad = new Date(a.date);
                if(a.date === todayStr) t += p;
                if(ad.getMonth() === cm && ad.getFullYear() === cy) m += p;
                rev += p; all++;
            });
            const finTodayEl = document.getElementById('finToday');
            const finMonthEl = document.getElementById('finMonth');
            const finAvgEl = document.getElementById('finAvg');
            if(finTodayEl) finTodayEl.innerText = t.toLocaleString() + ' ‚ÇΩ';
            if(finMonthEl) finMonthEl.innerText = m.toLocaleString() + ' ‚ÇΩ';
            if(finAvgEl) finAvgEl.innerText = (all ? Math.round(rev/all) : 0).toLocaleString() + ' ‚ÇΩ';
        }

        let calM = todayDate.getMonth(), calY = todayDate.getFullYear(), calSelected = todayStr;
        function changeCalMonth(s) { calM += s; if(calM<0){calM=11;calY--;} else if(calM>11){calM=0;calY++;} renderMonthCalendar(); }
        function renderMonthCalendar() {
            const titleEl = document.getElementById('calMonthYear');
            if(!titleEl) return;
            titleEl.innerText = `${monthNamesNom[calM]} ${calY}`;
            let grid = document.getElementById('calDaysGrid'), first = new Date(calY, calM, 1).getDay();
            grid.innerHTML = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"].map(d => `<div style="text-align:center; font-size:11px; color:gray">${d}</div>`).join('');
            first = (first === 0 ? 6 : first - 1);
            for(let i=0; i<first; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=new Date(calY, calM+1, 0).getDate(); d++) {
                let ds = `${calY}-${String(calM+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let h = db[ds] && db[ds].length > 0;
                let off = h && db[ds][0].isDayOff;
                grid.innerHTML += `<div onclick="calSelected='${ds}'; renderMonthCalendar()" class="day-cell ${ds===todayStr?'today':''} ${ds===calSelected?'selected':''} ${h?(off?'is-off':'has-apps'):''}" style="width:30px; height:30px; margin:auto">${d}</div>`;
            }
            const labelEl = document.getElementById('selectedDayLabel');
            if(labelEl) labelEl.innerText = "–ü–ª–∞–Ω—ã –Ω–∞ " + calSelected;
            const containerEl = document.getElementById('selectedDayAppsContainer');
            if(containerEl) containerEl.innerHTML = getDayHtml(calSelected, db[calSelected] || []);
        }

        function timeToMins(t) { let [h,m] = t.split(':').map(Number); return h*60+m; }
        function showToast(m, err=false) { 
            let t = document.getElementById('toastMessage'); 
            if(!t) return; 
            t.innerText=m; 
            t.style.backgroundColor=err?"#ff3b30":"#34c759"; 
            t.classList.add('show'); 
            try { tg.HapticFeedback.notificationOccurred(err ? 'error' : 'success'); } catch(e){}
            setTimeout(()=>t.classList.remove('show'), 2500); 
        }
        function toggleDayOffUI() { const reg = document.getElementById('regularFields'); if(reg) reg.style.display = document.getElementById('isDayOff').checked ? 'none' : 'block'; if(!document.getElementById('isDayOff').checked) generateTimeSlots(); }
        function resetAddForm() { document.getElementById('clientName').value=''; document.getElementById('notes').value=''; document.getElementById('appPrice').value=''; document.getElementById('isDayOff').checked=false; toggleDayOffUI(); }

        function generateTimeSlots() {
            let ds = document.getElementById('appDate').value, sel = document.getElementById('appTime'); if(!sel) return; sel.innerHTML = '';
            let booked = db[ds] || [], nm = (ds === todayStr) ? (new Date().getHours()*60 + new Date().getMinutes()) : -1;
            for(let h=9; h<=23; h++) {
                for(let m=0; m<60; m+=30) {
                    let mins = h*60+m; if(mins <= nm) continue;
                    if(booked.some(a => !a.isDayOff && Math.abs(mins - timeToMins(a.time)) < 30)) continue;
                    let ts = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    sel.innerHTML += `<option value="${ts}">${ts}</option>`;
                }
            }
        }

        async function saveAppointment() {
            let ds = document.getElementById('appDate').value, isOff = document.getElementById('isDayOff').checked;
            if(!ds) return showToast("–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É", true);

            const now = new Date();

            let item;
            if(isOff) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—à–ª–æ–µ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö
                let selectedDay = new Date(ds);
                selectedDay.setHours(23, 59, 59);
                if (selectedDay < now && ds !== todayStr) {
                    return showToast("‚ùå –ù–µ–ª—å–∑—è —Å—Ç–∞–≤–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –≤ –ø—Ä–æ—à–ª–æ–º!", true);
                }

                if(db[ds] && db[ds].length > 0 && !db[ds][0].isDayOff) return showToast("–¢–∞–º —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏!", true);
                item = { isDayOff: true, date: ds, notes: document.getElementById('notes').value };
                db[ds] = [item];
            } else {
                let n = document.getElementById('clientName').value, t = document.getElementById('appTime').value;
                if(!n || !t) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ –≤—Ä–µ–º—è", true);

                // --- –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –ó–ê–î–ù–ï–ì–û –ß–ò–°–õ–ê ---
                let selectedDateTime = new Date(`${ds}T${t}`);
                if (selectedDateTime < now) {
                    return showToast("‚ùå –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –∑–∞–¥–Ω–∏–º —á–∏—Å–ª–æ–º!", true);
                }

                item = { date: ds, time: t, name: n, price: document.getElementById('appPrice').value, service: document.getElementById('service').value, notes: document.getElementById('notes').value, telegram_id: masterTgId };
                if(!db[ds]) db[ds] = []; 
                db[ds].push(item);
            }
            
            localStorage.setItem('begy_crm', JSON.stringify(db));
            showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
            
            try { 
                await fetch(`${API_URL}/appointments`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }, 
                    body: JSON.stringify(item) 
                }); 
            } catch(e){
                console.error("Network Error (offline mode):", e);
            }
            
            setTimeout(() => openView('home'), 1000);
        }

        function getDayHtml(ds, apps) {
            if(apps.length === 0) return '<div style="text-align:center; padding:20px; color:gray">–°–≤–æ–±–æ–¥–Ω—ã–π –¥–µ–Ω—å üèñ</div>';
            if(apps[0].isDayOff) return '<div class="day-off-card">üèñ –í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å<br><small>'+(apps[0].notes||'')+'</small><br><button onclick="delete db[\''+ds+'\']; localStorage.setItem(\'begy_crm\', JSON.stringify(db)); renderMonthCalendar();" style="margin-top:10px; border:none; background:#ffcdd2; color:#c62828; padding:5px 10px; border-radius:5px">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>';
            return apps.sort((a,b)=>timeToMins(a.time)-timeToMins(b.time)).map(a => `
                <div class="list-item">
                    <div style="display:flex; align-items:center; gap:10px"><span class="time-badge">${a.time}</span><div><b>${a.name}</b><br><small>${a.service}</small></div></div>
                    <span class="price-text">${a.price||0} ‚ÇΩ</span>
                </div>
            `).join('');
        }

        function updateDashboard() {
            let all = Object.values(db).flat().filter(a => !a.isDayOff);
            const totalAppsEl = document.getElementById('totalAppsCounter');
            const totalClientsEl = document.getElementById('totalClientsCounter');
            if (totalAppsEl) totalAppsEl.innerText = all.length;
            if (totalClientsEl) totalClientsEl.innerText = new Set(all.map(a => a.name.trim().toLowerCase())).size;
            renderDashboardList();
        }

        function renderDashboardList() {
            let today = new Date();
            let tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            
            let t = document.getElementById('tabToday').classList.contains('active') ? formatDate(today) : formatDate(tomorrow);
            const listEl = document.getElementById('dashboardList');
            if(listEl) listEl.innerHTML = getDayHtml(t, db[t] || []);
        }

        function switchScheduleTab(t) {
            document.getElementById('tabToday').classList.toggle('active', t==='today');
            document.getElementById('tabTomorrow').classList.toggle('active', t==='tomorrow');
            renderDashboardList();
        }

        document.body.addEventListener('click', () => { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); if(ctx.state === 'suspended') ctx.resume(); } catch(e){} }, {once: true});
        
        // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
        updateDashboard();
    </script>
</body>
</html>